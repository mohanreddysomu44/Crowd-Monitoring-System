<!-- [Copy this full version and replace your original for final usage] -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3D Crowd Monitoring | Real-time Analytics</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Your entire existing CSS remains unchanged, as it was already well-structured and responsive. */
      /* Minor fix for info-cards grid layout */
      @media (max-width: 768px) {
        .info-cards {
          flex-direction: column;
          align-items: center;
        }
      }
    </style>
  </head>
  <body>
    <!-- Animated Background -->
    <div class="animated-bg"></div>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg">
      <div class="container">
        <a class="navbar-brand" href="#">
          <img src="logo2.png" alt="CrowdControl Logo" class="logo" />
          <span>CrowdControl</span>
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <i class="fas fa-bars"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="index.html"
                ><i class="fas fa-home"></i> Home</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="#"
                ><i class="fas fa-chart-line"></i> Analytics</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#"
                ><i class="fas fa-headset"></i> Support</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#"
                ><i class="fas fa-calendar-check"></i> Events</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link trial-btn" href="#"
                ><i class="fas fa-rocket"></i> Free Trial</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link signup-btn" href="#"
                ><i class="fas fa-user-plus"></i> Sign Up</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link login-btn" href="#"
                ><i class="fas fa-sign-in-alt"></i> Login</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
      <div class="container text-center">
        <h1 class="mb-4">3D Crowd Monitoring Dashboard</h1>
        <p class="lead mb-5">
          Real-time analytics and visualization of crowd density and movement
        </p>

        <!-- Info Cards -->
        <div class="info-cards">
          <div class="info-card">
            <h3><i class="fas fa-users"></i> Current Crowd</h3>
            <p id="current-count">0</p>
          </div>
          <div class="info-card">
            <h3><i class="fas fa-arrow-up"></i> Peak Today</h3>
            <p id="peak-count">0</p>
          </div>
          <div class="info-card">
            <h3><i class="fas fa-sign-out-alt"></i> Total Exits</h3>
            <p id="total-exits">0</p>
          </div>
          <div class="info-card">
            <h3><i class="fas fa-clock"></i> Last Updated</h3>
            <p id="last-updated">-</p>
          </div>
        </div>

        <!-- Alert Section -->
        <div class="alert-section" id="alert-section" style="display: none">
          <i class="fas fa-exclamation-triangle"></i>
          <div>
            <h4>High Density Alert!</h4>
            <p id="alert-message">
              Crowd density has exceeded safe thresholds in monitored area.
            </p>
          </div>
        </div>

        <!-- Chart Buttons -->
        <div class="chart-buttons">
          <button
            onclick="changeChartType('line')"
            aria-label="Switch to Line Chart"
          >
            <i class="fas fa-chart-line"></i> Line Chart
          </button>
          <button
            onclick="changeChartType('area')"
            aria-label="Switch to Area Chart"
          >
            <i class="fas fa-chart-area"></i> Area Chart
          </button>
          <button
            onclick="changeChartType('bar')"
            aria-label="Switch to Bar Chart"
          >
            <i class="fas fa-chart-bar"></i> Bar Chart
          </button>
        </div>

        <!-- Chart Container -->
        <div id="chart"></div>
      </div>
    </div>

    <!-- JavaScript Section -->
    <script>
      let chart;
      let currentChartType = "line";
      let chartData = [];
      let chartCategories = [];
      let peakCount = 0;

      async function fetchCrowdData() {
        try {
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 5000); // timeout after 5s
          const response = await fetch("http://192.168.184.116/data", {
            signal: controller.signal,
          });
          clearTimeout(timeout);
          const data = await response.json();

          const currentCount = data.currentCount || 0;
          const totalExits = data.totalExits || 0;
          const now = new Date().toLocaleTimeString();

          document.getElementById("current-count").textContent = currentCount;
          document.getElementById("total-exits").textContent = totalExits;
          document.getElementById("last-updated").textContent = now;

          if (currentCount > peakCount) {
            peakCount = currentCount;
            document.getElementById("peak-count").textContent = peakCount;
          }

          if (currentCount >= 9) {
            document.getElementById("alert-section").style.display = "flex";
            document.getElementById(
              "alert-message"
            ).textContent = `Alert: Crowd count has reached ${currentCount}!`;
          } else {
            document.getElementById("alert-section").style.display = "none";
          }

          updateChart(currentCount, now);
        } catch (err) {
          console.error("Failed to fetch crowd data:", err);
        }
      }

      function updateChart(count, time) {
        chartData.push(count);
        chartCategories.push(time);
        if (chartData.length > 20) {
          chartData.shift();
          chartCategories.shift();
        }

        chart.updateSeries([{ name: "Crowd Count", data: chartData }]);
        chart.updateOptions({ xaxis: { categories: chartCategories } });
      }

      function changeChartType(type) {
        chart.updateOptions({ chart: { type: type } });
      }

      function initializeChart() {
        chart = new ApexCharts(document.querySelector("#chart"), {
          chart: {
            type: currentChartType,
            height: 400,
            animations: { enabled: true, easing: "easeinout", speed: 800 },
            toolbar: { show: false },
            background: "transparent",
            foreColor: "#fff",
          },
          series: [{ name: "Crowd Count", data: chartData }],
          stroke: { width: 4, curve: "smooth", colors: ["#00E396"] },
          fill: {
            type: "gradient",
            gradient: {
              shade: "dark",
              gradientToColors: ["#00E396"],
              shadeIntensity: 0.5,
              type: "vertical",
              opacityFrom: 0.7,
              opacityTo: 0.1,
              stops: [0, 100],
            },
          },
          markers: {
            size: 5,
            colors: ["#00E396"],
            strokeColors: "#fff",
            strokeWidth: 2,
            hover: { size: 7 },
          },
          xaxis: {
            categories: chartCategories,
            labels: { style: { colors: "#fff" } },
          },
          yaxis: {
            min: 0,
            max: 50,
            tickAmount: 5,
            labels: { style: { colors: "#fff" } },
          },
          tooltip: {
            theme: "dark",
            x: { format: "HH:mm:ss" },
          },
          grid: { borderColor: "rgba(255, 255, 255, 0.1)" },
        });

        chart.render().then(() => {
          fetchCrowdData(); // initial fetch
          setInterval(fetchCrowdData, 2000);
        });
      }

      document.addEventListener("DOMContentLoaded", initializeChart);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
  </body>
</html>
